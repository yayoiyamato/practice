<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>非同期の練習</title>
</head>
<body>
<h1>非同期の練習</h1>
<div id="result"></div>
   
</body>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>

/*
 * ポイント情報を取得
 */
 function getAllPointData(isMember = true) {
  if (isMember) {
    let pointA = []
    let pointB = []
    getMemberData().done(function(memberData) {
      if (memberData.length > 0) {
        let pointDataAll = []
        memberData.some(function(e, i) {
          $.when.apply(null, getEachPointData(e.tel)).done(function(pointDataA, pointDataB) {
            pointDataA.forEach((data) => {
              pointDataAll.push(data)
              pointA.push(data)
            })
            pointDataB.forEach((data) => {
              pointDataAll.push(data)
              pointB.push(data)
            })
          }).fail(function() {
            return true
          }).always(function() {
            console.log(pointDataAll)
            console.log(pointA)
            console.log(pointB)
          })
        })
      }
    }).fail(function() {
      // 会員情報の取得に失敗したら08011111111のデータを取得
      console.log('会員情報の取得に失敗')
      getDefaultPointData()
    })
  } else {
    getDefaultPointData()
  }
}

/*
 * 会員情報を取得
 */
function getMemberData() {
  const d = $.Deferred()
  $.get("./members.json").done(function(memberData) {
    d.resolve(memberData)
  }).fail(function() {
    d.reject()
  })
  return d.promise()
}

/*
 * デフォルトのポイント情報を取得
 */
function getDefaultPointData() {
  const defaulTel = '08011111111'
  $.when.apply(null, getEachPointData(defaulTel)).done(function(pointDataA, pointDataB) {
    pointA = pointDataA
    pointB = pointDataB
    console.log(pointA, pointB)
  }).fail(function() {
    console.log('ポイント情報の取得に失敗')
  })
}

/*
 * 会員ごとのポイント情報を取得
 */
function getEachPointData(tel) {
  const da = $.Deferred()
  const db = $.Deferred()
  const task = []

  $.get("./pointsA.json").done(function(pointDataA) {
    da.resolve(pointDataA.filter((e) => e.tel === tel))
  }).fail(function() {
    console.log('ERROR：pointDataA')
    da.reject()
  })
  task.push(da.promise())

  $.get("./pointsB.json").done(function(pointDataB) {
    db.resolve(pointDataB.filter((e) => e.tel === tel))
  }).fail(function() {
    console.log('ERROR：pointDataB')
    db.reject()
  })
  task.push(db.promise())

  return task
}

getAllPointData()
</script>

</html>