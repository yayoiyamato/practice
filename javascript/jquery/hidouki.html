<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>非同期の練習</title>
</head>
<body>
<h1>非同期の練習</h1>
<div id="result"></div>
   
</body>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>

let dispPointA = []
let dispPointB = []
let allPoint = []

/*
 * ポイント情報を取得
 */
function getAllPointData(isMember = true) {
  if (isMember) {
    getMemberData().done(function(memberData) {
      if (memberData.length > 0) {
        memberData.some(function(e, i) {
          allPoint[e.tel] = []
          $.when.apply(null, getEachPointData(e.tel)).done(function(pointDataA, pointDataB) {
            // 表示用（全会員分がっちゃんこ）
            dispPointA.push(pointDataA[i])
            dispPointB.push(pointDataB[i])
            // 全件保存用（各会員ごとのかたまりに）
            allPoint[e.tel].push({
              "a": pointDataA[i],
              "b": pointDataB[i]
            })
            console.log(pointDataA)
            console.log(pointDataB)
            console.log(allPoint)
          }).fail(function() {
            return true
          })
        })
      }
    }).fail(function() {
      // 会員情報の取得に失敗したら08011111111のデータを取得
      console.log('会員情報の取得に失敗')
      getDefaultPointData()
    })
  } else {
    getDefaultPointData()
  }
}
/*
 * 会員情報を取得
 */
function getMemberData() {
  const d = $.Deferred()
  $.get("./members.json").done(function(memberData) {
    d.resolve(memberData)
  }).fail(function() {
    d.reject()
  })
  return d.promise()
}

/*
 * デフォルトのポイント情報を取得
 */
function getDefaultPointData() {
  const defaulTel = '08011111111'
  $.when.apply(null, getEachPointData(defaultTel)).done(function(pointDataA, pointDataB) {
    dispPointA = pointDataA
    dispPointB = pointDataB
    console.log(dispPointA, dispPointB)
  }).fail(function() {
    console.log('ポイント情報の取得に失敗')
  })
}

/*
 * 会員ごとのポイント情報を取得
 */
function getEachPointData(tel) {
  const da = $.Deferred()
  const db = $.Deferred()
  const task = []

  $.get("./pointsA.json").done(function(pointDataA) {
    da.resolve(pointDataA.filter((e) => e.tel === tel))
  }).fail(function() {
    console.log('ERROR：pointDataA')
    da.reject()
  })
  task.push(da.promise())

  $.get("./pointsB.json").done(function(pointDataB) {
    db.resolve(pointDataB.filter((e) => e.tel === tel))
  }).fail(function() {
    console.log('ERROR：pointDataB')
    db.reject()
  })
  task.push(db.promise())

  return task
}

getAllPointData()
</script>

</html>