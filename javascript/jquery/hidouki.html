<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>非同期の練習</title>
</head>
<style>
  .loading {
    background-color: pink;
  }
</style>
<body>
<h1>非同期の練習</h1>
<div id="temp-point-box" class="loading">
  <h2>ポイント情報（仮）</h2>
  <ul id="temp-point-list"></ul>
  <p id="temp-point-message">仮メッセージ：</p>
</div>
<div id="reg-point-box" class="loading">
  <h2>ポイント情報（本）</h2>
  <ul id="reg-point-list"></ul>
  <p id="reg-point-message">本メッセージ：</p>
</div>
<p id="common-message">共通：</p>
   
</body>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>
const ui = {
  tempPointBox: $("#temp-point-box"), 
  tempPointList: $("#temp-point-list"), 
  tempPointMessage: $("#temp-point-message"), 
  regPointBox: $("#reg-point-box"), 
  regPointList: $("#reg-point-list"), 
  regPointMessage: $("#reg-point-message"), 
  commonMessage: $("#common-message"),
}
const isMember = true
const defaultTel = '08011111111'
let memberList = []
let tempPointList = []
let tempPointMessage = ''
let regPointList = []
let regPointMessage = ''
let allPointList = []
let commonMessage = ''


/*
 * 呼び出し元
 */
pointSectionTask().done(function() {
  appendDOM()
  ui.tempPointBox.removeClass('loading')
  ui.regPointBox.removeClass('loading')
})

/*
 * ポイント情報全体処理
 * @return Promise
 */
function pointSectionTask() {
  const d = $.Deferred()
  if (isMember) {
    getMemberList().done(function() {
      let task = []
      memberList.some((m, i) => {
        const dp = getPointData(m.tel)
        task.push(dp)
      })
      // FIXME: Promise.all きいてへん
      Promise.all(task).then(function() {
        d.resolve()
      }, function() {
        // ポイント情報取得失敗したときの処理
        d.resolve()
      })
    }).fail(function() {
      console.log("fail")
    })
  } else {
    $.when.apply(null, getPointData()).always(function() {
      console.log(tempPointList, regPointList)
      d.resolve()
    })
  }
  return d.promise()
}

/*
 * グループ情報取得処理
 * @return Promise
 */
 function getMemberList() {
  const d = $.Deferred()
  $.get("./members.json").done((result) =>  {
    memberList = memberList.concat(result)
    d.resolve()
  }).fail(function() {
    commonMessage = 'グループ情報取得に失敗しました。全件表示できません。'
    d.resolve()
  })
  return d.promise()
}

/*
 * ポイント情報取得処理
 * @param {String} tel
 * @return Promise
 */
 function getPointData(tel = defaultTel) {
  const da = $.Deferred()
  const db = $.Deferred()
  const task = []

  $.get("./pointsA.json").done(function(result) {
    tempPointList = tempPointList.concat(result.filter(
      (e) => e.tel === tel)
    )
    da.resolve()
  }).fail(function() {
    tempPointMessage = 'ERROR：ポイント情報（仮）の取得に失敗しました。'
    da.reject()
  })
  task.push(da.promise())

  $.get("./pointsB.json").done(function(result) {
    regPointList = regPointList.concat(result.filter(
      (e) => e.tel === tel)
    )
    db.resolve()
  }).fail(function() {
    regPointMessage = 'ERROR：ポイント情報（本）の取得に失敗しました。'
    db.reject()
  })
  task.push(db.promise())

  return task
}

/*
 * HTML表示処理
 */
function appendDOM() {
  if (tempPointMessage) {
    ui.tempPointMessage.append(tempPointMessage)
  } else if (tempPointList) {
    tempPointList.forEach((e) => {
      ui.tempPointList.append(`<li>date:${e.date}　type:${e.type}　point:${e.point}　tel:${e.tel}</li>`)
    })
  }
  if (regPointMessage) {
    ui.regPointMessage.append(regPointMessage)
  } else if (regPointList) {
    regPointList.forEach((e) => {
      ui.regPointList.append(`<li>date:${e.date}　type:${e.type}　point:${e.point}　tel:${e.tel}</li>`)
    })
  }
  if (commonMessage) {
    ui.commonMessage.append(commonMessage)
  }
}


</script>

</html>